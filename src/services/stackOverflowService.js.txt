const axios = require('axios');
const { addIssues } = require('./devOpsClient');
const { removeDuplicates } = require('../utils');

// const applicationInsights = require("applicationinsights"); //Dana
// applicationInsights.setup().start();
// var telemetry = applicationInsights.defaultClient;

module.exports = class StackOverflowService {

    constructor({ tags, source }, lastRun, console, telemetry) {
        this.tags = tags;
        this.source = source;
        this.lastRun = Math.floor(lastRun.getTime() / 1000);
        this.console = console;
        this.telemetry = telemetry;

        this.process();
    }

    async process() {
        const items = await Promise.all(this.tags.map(async tag => await this.getIssues(tag)));
        // this.console.log("Raw item count: " + items.length.toString()); //Dana
        // this.telemetry.trackEvent({ name: `Raw item count: ${items}` }); //Dana

        const unique = removeDuplicates(items, ({ question_id }) => question_id);
        // this.console.log("Unique item count: " + unique.length.toString()); //Dana
        this.telemetry.trackEvent({ name: `Unique item count: ${unique.length.toString()}` }); //Dana

        // this.telemetry.trackEvent({name: `Raw items`, properties: {customProperty: items}}); //Dana
        // this.telemetry.trackEvent({name: `Unique items`, properties: {customProperty: items}}); //Dana

        const issues = unique.map(({
            body,
            title,
            question_id,
        }) => ({
            "System.Title": title.slice(0, 255).toString(),
            "System.Description": body,
            "Custom.IssueID": question_id,
            "Custom.IssueType": this.source,
            "Custom.IssueURL": `<a href="${this.getUrl(question_id)}"> ${this.getUrl(question_id)} </a>`
        }));
        addIssues(issues, this.console);
    }

    async getIssues(tagged) {
        try {
            const { data, data: { items } } = await axios.get(`https://api.stackexchange.com/2.2/questions`,
               {
                    params: {
                        fromdate: this.lastRun,
                        site: "stackoverflow",
                        filter: "withbody",
                        tagged
                    }
                }).catch(function (error) {
                    if (error.response) {
                        // The request was made and the server responded with a status code
                        // that falls out of the range of 2xx
                        this.telemetry.trackEvent({ name: `SO Error`, properties: {responseErrorData: error.response.data, responseErrorStatus: error.response.status, responseErrorHeaders: error.response.headers}});
                    } else if (error.request) {
                        // The request was made but no response was received
                        // `error.request` is an instance of XMLHttpRequest in the browser and an instance of
                        // http.ClientRequest in node.js
                        this.telemetry.trackEvent({ name: `SO No Response`, properties: {noResponse: error.request}});
                    } else {
                        // Something happened in setting up the request that triggered an Error
                        this.telemetry.trackEvent('Error', error.message);
                    } 
                });

            // this.console.log("Items in getIssues" + items.length.toString()) //Dana
            this.telemetry.trackEvent({ name: `SO Raw response`, properties: { fullStackOverflowResponse: data } }); //Dana

            return items

        } catch (error) {
            this.console.log(error);
            return [];
        }
    }

    getUrl(number) {
        return `https://stackoverflow.com/questions/${number}`
    }


}
